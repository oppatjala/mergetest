<dataConfig>
  <document>
    <entity name="activity" pk="id" dataSource="rw_db" onError="skip"
        query="select * from activity where status=1" 
        deltaQuery="select * from activity where last_modified_date > '${dataimporter.last_index_time}'"
        deltaImportQuery="select * from activity where id='${dataimporter.delta.id}'"
        deletedPkQuery="select id from activity where status!=1">

      <field column="id" name="id"/>
      <field column="name" name="name"/>
      <field column="description" name="description"/>
      <field column="cost" name="cost"/>
      <field column="max_capacity" name="max_capacity"/>
      <field column="num_open" name="num_open"/>
      <field column="max_age" name="max_age"/>
      <field column="min_age" name="min_age"/>
      <field column="membership_required" name="membership_required"/>
      <field column="status" name="status"/>
      <field column="start_date" name="start_date"/>
      <field column="end_date" name="end_date"/>
      <field column="last_modified_date" name="last_modified_date"/>

      <entity name="leaf_categories" dataSource="rw_db" query="select CAT.id AS leaf_category_ids, CAT.name AS leaf_category_names, CAT.parent_id AS parent_ids from category as CAT JOIN activity_categories as AC ON CAT.id=AC.category_id JOIN activity as ACT ON AC.activity_id=ACT.id where ACT.id='${activity.id}' and CAT.depth=2">
        <field column="leaf_category_ids" name="leaf_category_ids"/>
        <field column="leaf_category_names" name="leaf_category_names"/>
        
        <entity name="top_level_categories" dataSource="rw_db" query="select CAT.id AS top_level_category_ids, CAT.name AS top_level_category_names from category as CAT where CAT.id IN (${leaf_categories.parent_ids})">
          <field column="top_level_category_ids" name="top_level_category_ids"/>
          <field column="top_level_category_names" name="top_level_category_names"/>
        </entity>        
      </entity>

      <entity name="events" dataSource="rw_db" query="select AE.instructor AS event_instructors, AE.event_start AS event_start, AE.event_finish AS event_finish from activity_event as AE where AE.activity_id='${activity.id}' order by AE.event_start asc limit 1">
        <field column="event_instructor" name="first_event_instructor"/>
        <field column="event_start" name="first_event_start"/>
        <field column="event_finish" name="first_event_finish"/>
      </entity>

      <entity name="provider" dataSource="rw_db" transformer="TemplateTransformer" query="select PRO.id AS provider_id, PRO.name AS provider_name, PRO.service_address_id as address_id from provider as PRO JOIN activity as ACT ON ACT.provider_id=PRO.id where ACT.id='${activity.id}'">
        <field column="provider_id" name="provider_id"/>
        <field column="provider_name" name="provider_name"/>
        
        <field column="activity_name_and_provider_id" template="${provider.provider_id}_${activity.name}"/>

        <entity name="provider_coords" dataSource="rw_db" query="select CONCAT(ADDR.latitude,',',ADDR.longitude) as provider_coordinates, ADDR.city as provider_city, ADDR.address_state as provider_state, ADDR.zip_code as provider_zip_code from service_address as ADDR where ADDR.id='${provider.address_id}' and ADDR.latitude IS NOT NULL and ADDR.longitude IS NOT NULL">
          <field column="provider_coordinates" name="provider_coordinates"/>
          <field column="provider_city" name="provider_city"/>
          <field column="provider_state" name="provider_state"/>
          <field column="provider_zip_code" name="provider_zip_code"/>
        </entity>          

        <entity name="vendor" dataSource="rw_db" query="select VEN.id AS vendor_id, VEN.online_reservation_supported AS online_reservation_supported from vendor as VEN JOIN provider as PRO ON PRO.vendor_id=VEN.id where PRO.id='${provider.provider_id}'">
          <field column="vendor_id" name="vendor_id"/>
          <field column="online_reservation_supported" name="online_reservation_supported"/>
        </entity>        
      </entity>
      
    </entity>
  </document>
</dataConfig>
